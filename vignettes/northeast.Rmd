---
title: "Northeastern US Vegetation Calibration with STEPPS"
author: "Simon Goring"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## High Level Introduction

Paleovegetation reconstruction is important for understanding Earth system proceses, in particular, reliable models of paleovegetation that have well defined uncertainty and are spatially explicit can be used to constrain 'slow' Earth system processes.

STEPPS represents a new generation of spatio-temporal Bayesian models for vegetation reconstruction from pollen.  It uses information from a network of pollen sites, calibrated against vegetation data to estimate relevant parameters needed to constrain pollen production, transport and deposition across the landscape, which makes spatially structured predictions possible.

![Figure?]

## Data Preparation

As mentioned above, we require two key data products: (1) pollen data from sedimentary archives, and (2) some form of gridded (or grid-able) vegetation data that is co-located with the pollen data.  The data should have a common spatial projection (preferably with an isotropic coordinate system, so that unit steps are equidistance in all directions across the region of interest).

We will present here data from two sources.  Pollen data will be obtained from the [Neotoma Paleoecological Database](http://neotomadb.org) using the R package [`neotoma`]() (Goring &al, 2015).  Vegetation data will be obtained from the supplemental material of Paciorek et al ().  This data is the product of a conditional-autoregressive model the spatially smooths Pre-EuroAmerican Settlement forest cover data from the Upper Midwestern United States (Goring et al., 2016) and the Eastern United States (Cogbill).  This data comes in a netCDF format and is very large.  A [gist]() shows how to download this data and do some preliminary processing, but this vignette assumes that the vegetation data is gridded, with both mean cell values and standard deviations of the posterior draws from each cell & each taxon.

```{r, results = 'hide'}

# Prep the veg data using the gist at: http://XXXXXXXXX

veg_mean <- readr::read_csv('data/composition_v0.3.csv')

```

```{r, echo = FALSE, results='asis'}
knitr::kable(summary(veg_mean))
```

We see one of several things here.  There are `r ncol(veg_mean)` taxa, values sum to 1, and, it's posible to note, some of these taxa do not have direct, or clear, equivalents in the pollen data.

### Choosing a bounding box

When we examine the Pre-Settlement data (PSD) we see that it is projected in a Great Lake St Laurence Albers projection (`+init=espg:3175`).  Neotoma data can be queried using a bounding box, but only using lat/long coordinates with WGS84 datum (`+init=epsg:4376`).  

We are going to extract the bounding box from the veg data and query Neotoma:

```{r}
veg_box <- bbox_tran(veg_mean, '~ x + y',
                             '+init=epsg:3175', 
                             '+init=epsg:4326')
```

### Obtaining Pollen Data

```{r}
datasets <- neotoma::get_dataset(loc = veg_box, datasettype = 'pollen')

neotoma::plot_leaflet(datasets)
```

This gives us an interactive map in R, with information about individual sites.  If we were to download the site data we could further investigate the properties of the sites.

### Spatial & Taxonomic Cleaning

